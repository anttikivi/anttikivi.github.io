---
import MainLayout from "@/layouts/MainLayout.astro";
import type { Locale } from "@/locales";
import locales, { defaultLocale, getLang } from "@/locales";
import routes, { type RouteKey } from "@/routes";
import type { GetStaticPaths, InferGetStaticPropsType } from "astro";
import { getCollection, render } from "astro:content";

export const getStaticPaths = (async () => {
    const pages = await getCollection("pages");

    return pages.map((page) => {
        const parts = page.id.split("/");

        if (parts.length < 2) {
            throw new Error(`invalid page id: ${page.id}`);
        }

        const locale = parts[0] as Locale;

        if (!locales.includes(locale)) {
            throw new Error(`page id does not contain a valid locale: ${page.id}`);
        }

        const entry = page.id.slice(`${locale}/`.length, page.id.length - ".md".length);
        const routeKey = page.data.key ?? (entry as RouteKey);

        if (locale === defaultLocale) {
            return {
                params: {
                    locale: undefined,
                    slug: routes[locale][routeKey],
                },
                props: { page },
            };
        } else {
            return {
                params: {
                    locale: getLang(locale),
                    slug: routes[locale][routeKey],
                },
                props: { page },
            };
        }
    });
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { page } = Astro.props as Props;
const { Content } = await render(page);
---

<MainLayout title={page.data.title}>
    <div class="container">
        <h1 class="my-8 font-bold">{page.data.title}</h1>
        <div class="prose">
            <Content />
        </div>
    </div>
</MainLayout>
